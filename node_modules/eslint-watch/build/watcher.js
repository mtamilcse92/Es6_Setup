'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = watcher;

var _chokidar = require('chokidar');

var _chokidar2 = _interopRequireDefault(_chokidar);

var _eslint = require('eslint');

var _eslint2 = _interopRequireDefault(_eslint);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _settings = require('./settings');

var _settings2 = _interopRequireDefault(_settings);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var logger = (0, _logger2.default)('watcher');

logger.debug('Loaded');

var events = { change: 'change' };
var chokidarOptions = {
  ignored: /\.git|node_modules|bower_components/
};
var cliOptionProperties = ['config', 'eslintrc', 'ext', 'parser', 'cache', 'cacheLocation', 'ignore', 'ignorePath', 'ignorePattern', 'fix', 'parserOptions', 'global', 'format'];
var cliOptionMap = {
  config: 'configFile',
  eslintrc: 'useEslintrc',
  ext: 'extensions',
  cacheFile: 'cacheLocation'
};

function filterWarnings(results) {
  return _lodash2.default.reduce(results, function (curr, result) {
    if (result.warningCount) {
      var newResult = _lodash2.default.omit(result, 'messages');
      newResult.messages = _lodash2.default.find(result.messages, function (m) {
        return m.severity > 1;
      });
      curr.push(newResult);
      return curr;
    }
    curr.push(result);
    return curr;
  }, []);
}

///https://github.com/eslint/eslint/blob/233440e524aa41545b66b2c3c7ca26fe790e32e0/tests/lib/cli-engine.js#L105-L107

function watcher(options) {
  var cliOptions = (0, _lodash2.default)(options).pick(cliOptionProperties).reduce(function (result, value, key) {
    key = cliOptionMap[key] || key;
    result[key] = value;
    return result;
  }, {});
  logger.debug(cliOptions);
  logger.debug(options);
  var cli = new _eslint2.default.CLIEngine(cliOptions);

  // replace \ with / for Windows compatibility
  var formatterPath = cliOptions.format.replace(/\\/g, '/');

  // copied from eslint - if the path has a slash, it's a file.
  if (formatterPath.indexOf('/') > -1) {
    var cwd = process.cwd();

    formatterPath = _path2.default.resolve(cwd, formatterPath);
  } else {
    formatterPath = `./formatters/${formatterPath}`;
  }

  logger.debug('Trying to load formatter for re-lint from ' + formatterPath);

  var formatter = void 0;
  try {
    formatter = require(formatterPath);
  } catch (ex) {
    ex.message = `There was a problem loading formatter: ${formatterPath}\nError: ${ex.message}`;
    // Cannot proceed with re-linting if we don't have a formatter.
    throw ex;
  }

  function lintFile(path) {
    logger.debug('lintFile: %s', path);
    var report = cli.executeOnFiles(path);
    if (options.fix) {
      _eslint2.default.CLIEngine.outputFixes(report);
    }
    var results = _settings2.default.cliOptions.quiet ? filterWarnings(report.results) : report.results;
    logger.log(formatter(results));
  }

  function isWatchableExtension(filePath, extensions) {
    logger.debug(filePath, extensions);
    if (extensions) {
      return _lodash2.default.includes(extensions, _path2.default.extname(filePath));
    }

    // Use the ESLint default extension, if none is provided
    return _lodash2.default.includes(cli.options.extensions, _path2.default.extname(filePath));
  }
  var watchDir = options._.length ? options._ : [_path2.default.resolve('./')];

  _chokidar2.default.watch(watchDir, chokidarOptions).on(events.change, function changeEvent(path) {
    logger.debug('Changed:', path);
    if (!cli.isPathIgnored(path) && isWatchableExtension(path, options.ext)) {
      var watchPath = options.changed ? [path] : watchDir;
      lintFile(watchPath);
    }
  }).on('error', logger.error);

  logger.debug('Watching: %o', watchDir);
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93YXRjaGVyLmpzIl0sIm5hbWVzIjpbIndhdGNoZXIiLCJsb2dnZXIiLCJkZWJ1ZyIsImV2ZW50cyIsImNoYW5nZSIsImNob2tpZGFyT3B0aW9ucyIsImlnbm9yZWQiLCJjbGlPcHRpb25Qcm9wZXJ0aWVzIiwiY2xpT3B0aW9uTWFwIiwiY29uZmlnIiwiZXNsaW50cmMiLCJleHQiLCJjYWNoZUZpbGUiLCJmaWx0ZXJXYXJuaW5ncyIsInJlc3VsdHMiLCJyZWR1Y2UiLCJjdXJyIiwicmVzdWx0Iiwid2FybmluZ0NvdW50IiwibmV3UmVzdWx0Iiwib21pdCIsIm1lc3NhZ2VzIiwiZmluZCIsIm0iLCJzZXZlcml0eSIsInB1c2giLCJvcHRpb25zIiwiY2xpT3B0aW9ucyIsInBpY2siLCJ2YWx1ZSIsImtleSIsImNsaSIsIkNMSUVuZ2luZSIsImZvcm1hdHRlclBhdGgiLCJmb3JtYXQiLCJyZXBsYWNlIiwiaW5kZXhPZiIsImN3ZCIsInByb2Nlc3MiLCJyZXNvbHZlIiwiZm9ybWF0dGVyIiwicmVxdWlyZSIsImV4IiwibWVzc2FnZSIsImxpbnRGaWxlIiwicGF0aCIsInJlcG9ydCIsImV4ZWN1dGVPbkZpbGVzIiwiZml4Iiwib3V0cHV0Rml4ZXMiLCJxdWlldCIsImxvZyIsImlzV2F0Y2hhYmxlRXh0ZW5zaW9uIiwiZmlsZVBhdGgiLCJleHRlbnNpb25zIiwiaW5jbHVkZXMiLCJleHRuYW1lIiwid2F0Y2hEaXIiLCJfIiwibGVuZ3RoIiwid2F0Y2giLCJvbiIsImNoYW5nZUV2ZW50IiwiaXNQYXRoSWdub3JlZCIsIndhdGNoUGF0aCIsImNoYW5nZWQiLCJlcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7a0JBNEN3QkEsTzs7QUE1Q3hCOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7Ozs7O0FBRUEsSUFBTUMsU0FBUyxzQkFBTyxTQUFQLENBQWY7O0FBRUFBLE9BQU9DLEtBQVAsQ0FBYSxRQUFiOztBQUVBLElBQU1DLFNBQVMs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QUFDQWIsZUFBU29CLFNBQVQ7QUFDRDtBQUNGLEdBUEgsRUFPS0gsRUFQTCxDQU9RLE9BUFIsRUFPaUI1RCxPQUFPaUUsS0FQeEI7O0FBU0FqRSxTQUFPQyxLQUFQLENBQWEsY0FBYixFQUE2QnVELFFBQTdCO0FBQ0QiLCJmaWxlIjoid2F0Y2hlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaG9raWRhciBmcm9tICdjaG9raWRhcic7XG5pbXBvcnQgZXNsaW50IGZyb20gJ2VzbGludCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCBzZXR0aW5ncyBmcm9tICcuL3NldHRpbmdzJztcbmltcG9ydCBMb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5jb25zdCBsb2dnZXIgPSBMb2dnZXIoJ3dhdGNoZXInKTtcblxubG9nZ2VyLmRlYnVnKCdMb2FkZWQnKTtcblxuY29uc3QgZXZlbnRzID0geyBjaGFuZ2U6ICdjaGFuZ2UnIH07XG5jb25zdCBjaG9raWRhck9wdGlvbnMgPSB7XG4gIGlnbm9yZWQ6IC9cXC5naXR8bm9kZV9tb2R1bGVzfGJvd2VyX2NvbXBvbmVudHMvXG59O1xuY29uc3QgY2xpT3B0aW9uUHJvcGVydGllcyA9IFtcbiAgJ2NvbmZpZycsICdlc2xpbnRyYycsICdleHQnLFxuICAncGFyc2VyJywgJ2NhY2hlJywgJ2NhY2hlTG9jYXRpb24nLFxuICAnaWdub3JlJywgJ2lnbm9yZVBhdGgnLCAnaWdub3JlUGF0dGVybicsXG4gICdmaXgnLCAncGFyc2VyT3B0aW9ucycsICdnbG9iYWwnLCAnZm9ybWF0J1xuXTtcbmNvbnN0IGNsaU9wdGlvbk1hcCA9IHtcbiAgY29uZmlnOiAnY29uZmlnRmlsZScsXG4gIGVzbGludHJjOiAndXNlRXNsaW50cmMnLFxuICBleHQ6ICdleHRlbnNpb25zJyxcbiAgY2FjaGVGaWxlOiAnY2FjaGVMb2NhdGlvbidcbn07XG5cbmZ1bmN0aW9uIGZpbHRlcldhcm5pbmdzKHJlc3VsdHMpe1xuICByZXR1cm4gXy5yZWR1Y2UocmVzdWx0cywgKGN1cnIsIHJlc3VsdCkgPT57XG4gICAgaWYocmVzdWx0Lndhcm5pbmdDb3VudCl7XG4gICAgICBsZXQgbmV3UmVzdWx0ID0gXy5vbWl0KHJlc3VsdCwgJ21lc3NhZ2VzJyk7XG4gICAgICBuZXdSZXN1bHQubWVzc2FnZXMgPSBfLmZpbmQocmVzdWx0Lm1lc3NhZ2VzLCAobSkgPT4gbS5zZXZlcml0eSA+IDEpO1xuICAgICAgY3Vyci5wdXNoKG5ld1Jlc3VsdCk7XG4gICAgICByZXR1cm4gY3VycjtcbiAgICB9XG4gICAgY3Vyci5wdXNoKHJlc3VsdCk7XG4gICAgcmV0dXJuIGN1cnI7XG4gIH0sIFtdKTtcbn1cblxuLy8vaHR0cHM6Ly9naXRodWIuY29tL2VzbGludC9lc2xpbnQvYmxvYi8yMzM0NDBlNTI0YWE0MTU0NWI2NmIyYzNjN2NhMjZmZTc5MGUzMmUwL3Rlc3RzL2xpYi9jbGktZW5naW5lLmpzI0wxMDUtTDEwN1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB3YXRjaGVyKG9wdGlvbnMpIHtcbiAgbGV0IGNsaU9wdGlvbnMgPSBfKG9wdGlvbnMpXG4gICAgLnBpY2soY2xpT3B0aW9uUHJvcGVydGllcylcbiAgICAucmVkdWNlKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSl7XG4gICAgICBrZXkgPSBjbGlPcHRpb25NYXBba2V5XSB8fCBrZXk7XG4gICAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LCB7fSk7XG4gIGxvZ2dlci5kZWJ1ZyhjbGlPcHRpb25zKTtcbiAgbG9nZ2VyLmRlYnVnKG9wdGlvbnMpO1xuICBsZXQgY2xpID0gbmV3IGVzbGludC5DTElFbmdpbmUoY2xpT3B0aW9ucyk7XG5cblxuICAvLyByZXBsYWNlIFxcIHdpdGggLyBmb3IgV2luZG93cyBjb21wYXRpYmlsaXR5XG4gIGxldCBmb3JtYXR0ZXJQYXRoID0gY2xpT3B0aW9ucy5mb3JtYXQucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuXG4gICAvLyBjb3BpZWQgZnJvbSBlc2xpbnQgLSBpZiB0aGUgcGF0aCBoYXMgYSBzbGFzaCwgaXQncyBhIGZpbGUuXG4gIGlmIChmb3JtYXR0ZXJQYXRoLmluZGV4T2YoJy8nKSA+IC0xKSB7XG4gICAgY29uc3QgY3dkID0gcHJvY2Vzcy5jd2QoKTtcblxuICAgIGZvcm1hdHRlclBhdGggPSBwYXRoLnJlc29sdmUoY3dkLCBmb3JtYXR0ZXJQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBmb3JtYXR0ZXJQYXRoID0gYC4vZm9ybWF0dGVycy8ke2Zvcm1hdHRlclBhdGh9YDtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZygnVHJ5aW5nIHRvIGxvYWQgZm9ybWF0dGVyIGZvciByZS1saW50IGZyb20gJyArIGZvcm1hdHRlclBhdGgpO1xuXG4gIGxldCBmb3JtYXR0ZXI7XG4gIHRyeSB7XG4gICAgZm9ybWF0dGVyID0gcmVxdWlyZShmb3JtYXR0ZXJQYXRoKTtcbiAgfSBjYXRjaCAoZXgpIHtcbiAgICBleC5tZXNzYWdlID0gYFRoZXJlIHdhcyBhIHByb2JsZW0gbG9hZGluZyBmb3JtYXR0ZXI6ICR7Zm9ybWF0dGVyUGF0aH1cXG5FcnJvcjogJHtleC5tZXNzYWdlfWA7XG4gICAgLy8gQ2Fubm90IHByb2NlZWQgd2l0aCByZS1saW50aW5nIGlmIHdlIGRvbid0IGhhdmUgYSBmb3JtYXR0ZXIuXG4gICAgdGhyb3cgZXg7XG4gIH1cblxuICBmdW5jdGlvbiBsaW50RmlsZShwYXRoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdsaW50RmlsZTogJXMnLCBwYXRoKTtcbiAgICBsZXQgcmVwb3J0ID0gY2xpLmV4ZWN1dGVPbkZpbGVzKHBhdGgpO1xuICAgIGlmIChvcHRpb25zLmZpeCkge1xuICAgICAgZXNsaW50LkNMSUVuZ2luZS5vdXRwdXRGaXhlcyhyZXBvcnQpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHRzID0gc2V0dGluZ3MuY2xpT3B0aW9ucy5xdWlldCA/IGZpbHRlcldhcm5pbmdzKHJlcG9ydC5yZXN1bHRzKSA6IHJlcG9ydC5yZXN1bHRzO1xuICAgIGxvZ2dlci5sb2coZm9ybWF0dGVyKHJlc3VsdHMpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzV2F0Y2hhYmxlRXh0ZW5zaW9uKGZpbGVQYXRoLCBleHRlbnNpb25zKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGZpbGVQYXRoLCBleHRlbnNpb25zKTtcbiAgICBpZiAoZXh0ZW5zaW9ucykge1xuICAgICAgcmV0dXJuIF8uaW5jbHVkZXMoZXh0ZW5zaW9ucywgcGF0aC5leHRuYW1lKGZpbGVQYXRoKSk7XG4gICAgfVxuXG4gICAgLy8gVXNlIHRoZSBFU0xpbnQgZGVmYXVsdCBleHRlbnNpb24sIGlmIG5vbmUgaXMgcHJvdmlkZWRcbiAgICByZXR1cm4gXy5pbmNsdWRlcyhjbGkub3B0aW9ucy5leHRlbnNpb25zLCBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpKTtcbiAgfVxuICBsZXQgd2F0Y2hEaXIgPSBvcHRpb25zLl8ubGVuZ3RoID8gb3B0aW9ucy5fIDogW3BhdGgucmVzb2x2ZSgnLi8nKV07XG5cbiAgY2hva2lkYXIud2F0Y2god2F0Y2hEaXIsIGNob2tpZGFyT3B0aW9ucylcbiAgICAub24oZXZlbnRzLmNoYW5nZSwgZnVuY3Rpb24gY2hhbmdlRXZlbnQocGF0aCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdDaGFuZ2VkOicsIHBhdGgpO1xuICAgICAgaWYgKCFjbGkuaXNQYXRoSWdub3JlZChwYXRoKSAmJiBpc1dhdGNoYWJsZUV4dGVuc2lvbihwYXRoLCBvcHRpb25zLmV4dCkpIHtcbiAgICAgICAgY29uc3Qgd2F0Y2hQYXRoID0gb3B0aW9ucy5jaGFuZ2VkID8gW3BhdGhdIDogd2F0Y2hEaXI7XG4gICAgICAgIGxpbnRGaWxlKHdhdGNoUGF0aCk7XG4gICAgICB9XG4gICAgfSkub24oJ2Vycm9yJywgbG9nZ2VyLmVycm9yKTtcblxuICBsb2dnZXIuZGVidWcoJ1dhdGNoaW5nOiAlbycsIHdhdGNoRGlyKTtcbn07XG4iXX0=